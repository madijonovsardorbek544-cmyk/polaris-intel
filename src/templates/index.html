<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POLARIS Intel — Cyber & Geopolitical Risk</title>
  <style>
    body{font-family:system-ui,Arial; margin:0; background:#0b1220; color:#e8eefc}
    header{padding:28px 18px; border-bottom:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)}
    .wrap{max-width:980px; margin:0 auto}
    h1{margin:0 0 8px; font-size:28px}
    p{margin:0; opacity:.85; line-height:1.5}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}
    .btn{background:#2d6cdf; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn.sec{background:rgba(255,255,255,.08); color:#e8eefc}
    main{padding:18px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px}
    .meta{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; opacity:.85}
    .pill{padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08)}
    .danger{background:rgba(255,80,80,.18); border:1px solid rgba(255,80,80,.25)}
    .warn{background:rgba(255,190,80,.16); border:1px solid rgba(255,190,80,.25)}
    .ok{background:rgba(80,220,160,.14); border:1px solid rgba(80,220,160,.22)}
    a{color:#8fb4ff}
    .small{font-size:12px; opacity:.75}
    .topline{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap}
    .status{font-size:12px; opacity:.8}
    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topline">
        <div>
          <h1>POLARIS Intel</h1>
          <p>Cyber + geopolitical risk intelligence. Live feed from your API.</p>
        </div>
        <div class="status" id="status">Status: loading…</div>
      </div>

      <div class="row">
        <button class="btn" id="refreshBtn">Refresh latest</button>
        <a class="btn sec" href="/docs" style="text-decoration:none; display:inline-block">Open API Docs</a>
        <a class="btn sec" href="/reports" style="text-decoration:none; display:inline-block">Reports page</a>
      </div>

      <p class="small" style="margin-top:10px;">
        API endpoint: <code>/api/latest</code>
      </p>
    </div>
  </header>

  <main class="wrap">
    <div class="grid" id="cards"></div>
  </main>

<script>
  function safe(v){ return (v === null || v === undefined) ? "" : String(v); }

  function levelFromScore(score){
    const s = Number(score);
    if (!Number.isFinite(s)) return "N/A";
    if (s >= 75) return "High";
    if (s >= 50) return "Medium";
    return "Low";
  }

  function levelClass(level){
    const v = String(level || "").toLowerCase();
    if (v.includes("high") || v.includes("critical")) return "danger";
    if (v.includes("medium")) return "warn";
    if (v.includes("low")) return "ok";
    return "";
  }

  async function loadLatest(){
    const status = document.getElementById("status");
    const cards  = document.getElementById("cards");
    const btn    = document.getElementById("refreshBtn");

    status.textContent = "Status: fetching…";
    btn.disabled = true;
    cards.innerHTML = "";

    try{
      const res = await fetch("/api/latest", { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.risks || data.items || []);

      if(!items.length){
        cards.innerHTML = '<div class="card">No items yet. Add data to <code>/api/latest</code> and refresh.</div>';
        status.textContent = "Status: OK (0 items)";
        return;
      }

      items.forEach((it, idx) => {
        const title    = safe(it.title || it.headline || ("Item " + (idx+1)));
        const category = safe(it.category || it.type || "N/A");
        const score    = (it.risk_score !== undefined) ? it.risk_score : it.score;
        const level    = safe(it.risk_level || it.level || levelFromScore(score));
        const summary  = safe(it.explanation || it.summary || it.reason || "");
        const source   = safe(it.source || it.url || "");
        const tags     = Array.isArray(it.tags) ? it.tags : [];

        const div = document.createElement("div");
        div.className = "card " + levelClass(level);

        const tagsHtml = tags.slice(0,4).map(t => `<span class="pill">${safe(t)}</span>`).join("");

        div.innerHTML = `
          <div class="meta">
            <span class="pill">#${idx+1}</span>
            <span class="pill">Category: ${category}</span>
            <span class="pill">Risk: ${level}</span>
            ${Number.isFinite(Number(score)) ? `<span class="pill">Score: ${Number(score)}</span>` : ``}
            ${tagsHtml}
          </div>
          <h3 style="margin:10px 0 6px">${title}</h3>
          ${summary
            ? `<p style="margin:0 0 10px; opacity:.92">${summary}</p>`
            : `<p style="margin:0 0 10px; opacity:.7">(no explanation yet)</p>`
          }
          ${source
            ? `<p class="small">Source: <a href="${source}" target="_blank" rel="noreferrer">${source}</a></p>`
            : ``
          }
        `;

        cards.appendChild(div);
      });

      status.textContent = "Status: OK (" + items.length + " items)";
    }catch(e){
      status.textContent = "Status: error";
      cards.innerHTML = `<div class="card">Failed to load <code>/api/latest</code>. Error: ${safe(e.message)}</div>`;
    }finally{
      btn.disabled = false;
    }
  }

  document.getElementById("refreshBtn").addEventListener("click", loadLatest);
  loadLatest();
</script>
</body>
</html>